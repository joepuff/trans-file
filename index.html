<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>p2pä¸­è½¬(V21 ARQ-Fix)</title>
    
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root { --primary: #ff3b30; --bg: #f2f2f7; --card-bg: #fff; --text: #1c1c1e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; max-width: 640px; margin: 0 auto; padding: 16px; background: var(--bg); color: var(--text); }
        
        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); margin-bottom: 20px; }
        .tag { font-size: 0.7rem; background: #ffe4e4; color: #d60000; padding: 3px 8px; border-radius: 6px; font-weight: 700; margin-left: 5px; }
        
        /* UI ç»§æ‰¿è‡ª V20 çš„å®Œç¾å¸ƒå±€ */
        .input-group { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { flex: 1 1 100%; min-width: 200px; padding: 12px; border: 1px solid #e5e5ea; border-radius: 10px; font-family: monospace; outline: none; }
        .btn-row { display: flex; gap: 8px; flex: 1 1 auto; }
        button { height: 44px; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s;}
        .btn-icon { background: #e9e9eb; flex: 1; }
        .btn-main { background: var(--primary); color: white; flex: 2; }
        
        @media (min-width: 480px) { input[type="text"] { flex: 2; } .btn-row { flex: 3; } }

        #status { font-size: 0.9rem; color: #636366; text-align: center; margin-bottom: 20px; padding: 10px; background: #f2f2f7; border-radius: 10px; }
        
        .file-box { border: 2px dashed #c7c7cc; padding: 40px 20px; text-align: center; border-radius: 12px; cursor: pointer; background: #fff; }
        
        .progress-wrap { margin-top: 20px; display: none; }
        .progress-bar { height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.1s linear; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.8rem; color: #8e8e93; margin-top: 6px; }

        .log-item { padding: 15px 0; border-bottom: 1px solid #e5e5ea; }
        .media-preview { width: 100%; max-height: 300px; border-radius: 8px; background: #000; margin-top: 10px; object-fit: contain; }
        .btn-dl { font-size: 0.85rem; color: var(--primary); text-decoration: none; padding: 6px 12px; background: #fff0f5; border-radius: 8px; display: inline-block; margin-top: 8px; font-weight: bold;}

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content:center; align-items:center; z-index:999; flex-direction: column; }
        #qrcode-gen { background: white; padding: 20px; border-radius: 20px; }
        #reader { width: 100%; max-width: 400px; border-radius: 16px; overflow: hidden; }
        .close-btn { margin-top: 20px; background: white; padding: 10px 30px; border-radius: 30px; }
    </style>
</head>
<body>
    <div class="card">
        <h3>V21 è‡ªåŠ¨é‡ä¼ ç‰ˆ <span class="tag">ARQ</span></h3>
        <div style="font-size:0.85rem; color:#8e8e93; margin-bottom:15px">ä¸¢åŒ…è‡ªåŠ¨ä¿®å¤ â€¢ å¼±ç½‘ç¯å¢ƒå¢å¼º</div>
        
        <div class="input-group">
            <input type="text" id="credentialInput" placeholder="è¾“å…¥32ä½å‡­è¯" maxlength="32">
            <div class="btn-row">
                <button class="btn-icon" onclick="genKey()">ğŸ²</button>
                <button class="btn-icon" onclick="showQR()">ğŸ“±</button>
                <button class="btn-icon" onclick="scanQR()">ğŸ“·</button>
                <button class="btn-main" onclick="initApp()">è¿æ¥</button>
            </div>
        </div>
        
        <div id="status">ç­‰å¾…æ“ä½œ...</div>

        <div id="panel" style="display:none;">
            <div class="file-box" onclick="document.getElementById('fileInput').click()">
                <div style="font-size:2.5rem; margin-bottom:10px">ğŸ“¤</div>
                <div style="font-weight:600">ç‚¹å‡»å‘é€æ–‡ä»¶</div>
                <div style="font-size:0.85rem; color:#8e8e93; margin-top:5px">æ”¯æŒ 500MB+ æ–­ç‚¹è¡¥ä¼ </div>
                <input type="file" id="fileInput" style="display:none">
            </div>
            
            <div class="progress-wrap" id="prog-box">
                <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
                <div class="progress-info">
                    <span id="p-txt">0%</span>
                    <span id="p-detail">0/0 MB</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h4 style="margin:0 0 10px 0; color:#8e8e93; font-size:0.9rem;">ä¼ è¾“è®°å½•</h4>
        <div id="history"><div style="text-align:center; color:#c7c7cc; font-size:0.9rem; padding:10px">æš‚æ— è®°å½•</div></div>
    </div>

    <div id="qr-modal" class="modal" onclick="this.style.display='none'"><div id="qrcode-gen"></div></div>
    <div id="scan-modal" class="modal"><div id="reader"></div><button class="close-btn" onclick="stopScan()">å…³é—­æ‘„åƒå¤´</button></div>

    <script>
        const CHUNK_SIZE = 64 * 1024; 
        const CONFIG = {
            pbkdf2: { name: "PBKDF2", hash: "SHA-256", iterations: 500000 },
            aes: { name: "AES-GCM", length: 256 },
            salt_room: "V21_ARQ_ROOM", salt_key: "V21_ARQ_KEY"
        };

        const SecurityCore = {
            encKey: null,
            async init(password) {
                const enc = new TextEncoder();
                const baseKey = await crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
                this.encKey = await crypto.subtle.deriveKey({ ...CONFIG.pbkdf2, salt: enc.encode(CONFIG.salt_key) }, baseKey, CONFIG.aes, false, ["encrypt", "decrypt"]);
                const hash = await crypto.subtle.digest('SHA-256', enc.encode(password + CONFIG.salt_room));
                return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('').substr(0,32);
            },
            async encrypt(chunk) {
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, this.encKey, chunk);
                const packed = new Uint8Array(12 + cipher.byteLength);
                packed.set(iv, 0); packed.set(new Uint8Array(cipher), 12);
                return packed;
            },
            async decrypt(packed) {
                const iv = packed.slice(0, 12);
                const cipher = packed.slice(12);
                return await crypto.subtle.decrypt({name:"AES-GCM", iv}, this.encKey, cipher);
            }
        };

        let peer, conn;
        // æ¥æ”¶çŠ¶æ€
        let incoming = { chunks: [], meta: null, receivedCount: 0, totalChunks: 0 };
        // å‘é€çŠ¶æ€ (ç”¨äºé‡ä¼ æ—¶è¯»å–æ–‡ä»¶)
        let sendingFile = null; 
        let isBusy = false;

        async function initApp() {
            const code = document.getElementById('credentialInput').value.trim();
            if(code.length !== 32) return alert("å‡­è¯éœ€32ä½");
            setStatus("ğŸ” åŠ å¯†æ¡æ‰‹ä¸­...");
            setTimeout(async () => {
                try {
                    const roomId = await SecurityCore.init(code);
                    connectPeer(roomId);
                } catch(e) { setStatus("âŒ åˆå§‹åŒ–å¤±è´¥"); }
            }, 50);
        }

        function connectPeer(roomId) {
            if(peer) peer.destroy();
            peer = new Peer(roomId, {
                host: '0.peerjs.com', port: 443, secure: true, path: '/',
                config: { iceServers: [
                    { urls: 'stun:stun.miwifi.com' }, { urls: 'stun:stun.chat.bilibili.com' }, { urls: 'stun:stun.qq.com' }
                ]}
            });
            peer.on('open', () => { setStatus("âœ… èŠ‚ç‚¹å°±ç»ª (ARQ)"); peer.on('connection', setupConn); });
            peer.on('error', e => {
                if(e.type === 'unavailable-id') {
                    setStatus("ğŸ”— è¿æ¥æˆ¿ä¸»...");
                    const guest = new Peer({ host: '0.peerjs.com', port: 443, secure: true, path: '/', config: { iceServers: [{ urls: 'stun:stun.miwifi.com' }] } });
                    guest.on('open', () => setupConn(guest.connect(roomId)));
                } else setStatus("âŒ " + e.type);
            });
        }

        function setupConn(c) {
            conn = c;
            conn.on('open', () => { setStatus("ğŸ¤ è¿æ¥æˆåŠŸ"); document.getElementById('panel').style.display = 'block'; });
            conn.on('data', handleData);
            conn.on('close', () => setStatus("ğŸ”Œ æ–­å¼€"));
        }

        // --- å‘é€é€»è¾‘ ---
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file || !conn) return;
            if(isBusy) return alert("å¿™ç¢Œä¸­");
            
            isBusy = true;
            sendingFile = file; // ä¿å­˜å¼•ç”¨ä»¥ä¾¿é‡ä¼ 
            document.getElementById('prog-box').style.display = 'block';
            
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            conn.send({ type: 'meta', name: file.name, size: file.size, mime: file.type, total: totalChunks });
            
            // é¦–æ¬¡å…¨é‡å‘é€
            sendChunksRange(0, totalChunks - 1, totalChunks);
        });

        // é€šç”¨å‘é€å‡½æ•° (æ”¯æŒå…¨é‡å‘é€ å’Œ è¡¥å‘ç‰¹å®šåˆ—è¡¨)
        async function sendChunksRange(start, end, total, specificList = null) {
            const file = sendingFile;
            let list = specificList;
            
            // å¦‚æœæ²¡æœ‰æŒ‡å®šåˆ—è¡¨ï¼Œå°±ç”Ÿæˆä» start åˆ° end çš„åºåˆ—
            if(!list) {
                list = [];
                for(let i=start; i<=end; i++) list.push(i);
            }

            const reader = new FileReader();
            let idx = 0;

            const sendNext = async () => {
                if(idx >= list.length) {
                    // æœ¬è½®å‘é€ç»“æŸ
                    if(!specificList) {
                        conn.send({ type: 'end' }); // é¦–æ¬¡å‘é€å®Œæ¯•ï¼Œå‘ä¿¡å·
                        setStatus("â³ ç­‰å¾…æ¥æ”¶æ–¹ç¡®è®¤...");
                    } else {
                        conn.send({ type: 'retry-end' }); // è¡¥å‘å®Œæ¯•
                        setStatus("ğŸ”„ è¡¥å‘å®Œæˆï¼Œç­‰å¾…æ ¡éªŒ...");
                    }
                    return;
                }

                const seq = list[idx];
                const offset = seq * CHUNK_SIZE;
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                
                reader.onload = async (evt) => {
                    if(!conn || !conn.open) return;
                    const encrypted = await SecurityCore.encrypt(evt.target.result);
                    conn.send({ type: 'chunk', seq: seq, payload: encrypted });
                    
                    idx++;
                    // ä»…åœ¨é¦–æ¬¡å‘é€æ—¶æ›´æ–°å¤§è¿›åº¦æ¡
                    if(!specificList) {
                        const percent = Math.min(100, Math.round((seq / total) * 100));
                        updateBar(percent, seq * CHUNK_SIZE, file.size, "å‘é€ä¸­");
                    }
                    setTimeout(sendNext, 0); // é¿å…å¡é¡¿
                };
                reader.readAsArrayBuffer(slice);
            };
            sendNext();
        }

        // --- æ¥æ”¶ä¸ARQé€»è¾‘ ---
        async function handleData(data) {
            // 1. å…ƒæ•°æ®
            if (data.type === 'meta') {
                incoming = { chunks: new Array(data.total), meta: data, receivedCount: 0, receivedBytes: 0, totalChunks: data.total };
                isBusy = true;
                document.getElementById('prog-box').style.display = 'block';
                setStatus(`â¬‡ æ¥æ”¶: ${data.name}`);
                return;
            }

            // 2. æ•°æ®åˆ†ç‰‡
            if (data.type === 'chunk' && isBusy) {
                try {
                    // å¦‚æœè¯¥åˆ†ç‰‡è¿˜æ²¡æ”¶è¿‡ (é¿å…é‡å¤è§£å¯†)
                    if(!incoming.chunks[data.seq]) {
                        const decrypted = await SecurityCore.decrypt(data.payload);
                        incoming.chunks[data.seq] = decrypted;
                        incoming.receivedCount++;
                        incoming.receivedBytes += decrypted.byteLength;
                        
                        const percent = Math.min(100, Math.round((incoming.receivedCount / incoming.totalChunks) * 100));
                        updateBar(percent, incoming.receivedBytes, incoming.meta.size, "æ¥æ”¶ä¸­");
                    }
                } catch(e) {}
                return;
            }

            // 3. ç»“æŸä¿¡å· (é¦–æ¬¡æˆ–è¡¥å‘)
            if ((data.type === 'end' || data.type === 'retry-end') && isBusy) {
                checkIntegrityAndRetry();
                return;
            }

            // 4. å‘é€æ–¹æ”¶åˆ°é‡ä¼ è¯·æ±‚
            if (data.type === 'retry-req') {
                setStatus(`âš ï¸ å¯¹æ–¹è¯·æ±‚è¡¥å‘ ${data.list.length} ä¸ªåˆ†ç‰‡...`);
                sendChunksRange(0, 0, 0, data.list); // è°ƒç”¨è¡¥å‘é€»è¾‘
            }
        }

        // æ ¸å¿ƒï¼šå®Œæ•´æ€§æ£€æŸ¥ä¸é‡ä¼ è¯·æ±‚
        function checkIntegrityAndRetry() {
            let missingList = [];
            for(let i=0; i<incoming.totalChunks; i++) {
                if(!incoming.chunks[i]) missingList.push(i);
            }

            if(missingList.length > 0) {
                setStatus(`âš ï¸ å‘ç° ${missingList.length} ä¸ªä¸¢åŒ…ï¼Œè¯·æ±‚è¡¥å‘...`);
                // å‘é€é‡ä¼ è¯·æ±‚
                conn.send({ type: 'retry-req', list: missingList });
            } else {
                finishReceive();
            }
        }

        function finishReceive() {
            let mime = incoming.meta.mime;
            if(!mime || mime==='application/octet-stream') {
                if(incoming.meta.name.match(/\.mp4$/i)) mime = 'video/mp4';
                else if(incoming.meta.name.match(/\.(jpg|png|jpeg)$/i)) mime = 'image/jpeg';
            }

            const blob = new Blob(incoming.chunks, { type: mime });
            const url = URL.createObjectURL(blob);
            addHistory(incoming.meta.name, "â¬‡ æ”¶åˆ°", formatSize(incoming.meta.size), url, mime);
            
            isBusy = false;
            incoming.chunks = []; // é‡Šæ”¾å†…å­˜
            setStatus("âœ… æ¥æ”¶å®Œæˆ (100% å®Œæ•´)");
        }

        // --- UI å·¥å…· ---
        function updateBar(p, curr, total, txt) {
            document.getElementById('p-fill').style.width = p + '%';
            document.getElementById('p-txt').innerText = `${txt} ${p}%`;
            document.getElementById('p-detail').innerText = `${formatSize(curr)}/${formatSize(total)}`;
        }

        function addHistory(name, type, size, url, mime) {
            const div = document.getElementById('history');
            if(div.innerText.includes('æš‚æ— ')) div.innerHTML = '';
            
            let preview = '';
            if (url) {
                if (mime && mime.startsWith('video/')) preview = `<video src="${url}" controls class="media-preview" playsinline></video>`;
                else if (mime && mime.startsWith('image/')) preview = `<img src="${url}" class="media-preview">`;
            }

            const color = type.includes('å‘é€') ? '#007aff' : '#34c759';
            const html = `
                <div class="log-item">
                    <div style="font-weight:600; color:${color}; margin-bottom:4px;">${type} <span style="font-weight:normal;color:#8e8e93;font-size:0.8em">(${size})</span></div>
                    <div style="word-break:break-all; font-family:monospace; font-size:0.9em; color:#333">${name}</div>
                    ${url ? `<a href="${url}" download="${name}" class="btn-dl">ğŸ’¾ ä¿å­˜åˆ°æœ¬åœ°</a>` : ''}
                    ${preview}
                </div>`;
            div.innerHTML = html + div.innerHTML;
        }

        function genKey() {
            const arr = new Uint8Array(16); crypto.getRandomValues(arr);
            document.getElementById('credentialInput').value = Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
        function formatSize(b) { return b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB'; }
        function setStatus(s) { document.getElementById('status').innerText = s; }

        let html5QrCode;
        window.onload = () => { if(location.hash.includes('c=')) { document.getElementById('credentialInput').value = location.hash.split('c=')[1]; setTimeout(initApp, 500); history.replaceState(null, null, ' '); } };
        function showQR() {
            const c = document.getElementById('credentialInput').value;
            if(c.length!=32) return alert("éœ€32ä½å‡­è¯");
            document.getElementById('qr-modal').style.display = 'flex';
            document.getElementById('qrcode-gen').innerHTML = '';
            new QRCode(document.getElementById('qrcode-gen'), { text: location.href.split('#')[0]+'#c='+c, width: 220, height: 220 });
        }
        function scanQR() {
            document.getElementById('scan-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                (decodedText) => { stopScan(); const code = decodedText.includes('c=') ? decodedText.split('c=')[1] : decodedText; if(code.length===32) { document.getElementById('credentialInput').value = code; setTimeout(initApp, 500); } }
            ).catch(() => { alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´(éœ€HTTPS)"); stopScan(); });
        }
        function stopScan() { if(html5QrCode) html5QrCode.stop().then(() => { html5QrCode.clear(); document.getElementById('scan-modal').style.display = 'none'; }).catch(()=>{}); else document.getElementById('scan-modal').style.display = 'none'; }
    </script>
</body>
</html>
