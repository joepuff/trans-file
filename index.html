<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>p2pæ–‡ä»¶ä¸­è½¬(V19)</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        :root { --primary: #000000; --bg: #f5f5f7; --accent: #0066cc; }
        body { font-family: -apple-system, sans-serif; max-width: 600px; margin: 0 auto; padding: 15px; background: var(--bg); color: #1d1d1f; }
        
        .card { background: white; padding: 25px; border-radius: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .tag { font-size: 0.7em; background: #e5f1ff; color: var(--accent); padding: 3px 8px; border-radius: 12px; font-weight: 600; vertical-align: middle; margin-left: 8px;}
        
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { flex: 1; padding: 14px; border: 1px solid #d2d2d7; border-radius: 12px; font-family: monospace; font-size: 1.1em; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--accent); }
        
        button { padding: 0 16px; height: 48px; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1em; }
        button:active { transform: scale(0.96); opacity: 0.8; }
        .btn-icon { background: #e5e5ea; color: #1d1d1f; }
        .btn-main { background: var(--accent); color: white; min-width: 80px; }
        
        #status { font-size: 0.9em; color: #86868b; text-align: center; margin-bottom: 15px; padding: 8px; border-radius: 8px; background: #f5f5f7;}
        
        .file-box { border: 2px dashed #d2d2d7; padding: 40px 20px; text-align: center; border-radius: 16px; cursor: pointer; transition: 0.2s; background: white; }
        .file-box:active { background: #f5f5f7; border-color: var(--accent); }
        
        .progress-wrap { margin-top: 20px; display: none; }
        .progress-bar { height: 6px; background: #e5e5ea; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }
        .progress-info { display: flex; justify-content: space-between; font-size: 0.8em; color: #86868b; margin-top: 6px; }

        .log-item { padding: 15px 0; border-bottom: 1px solid #e5e5ea; display: flex; flex-direction: column; gap: 8px; }
        .log-top { display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; }
        .media-preview { width: 100%; border-radius: 12px; background: black; margin-top: 8px; max-height: 300px; object-fit: contain; }
        .btn-dl { font-size: 0.85em; color: var(--accent); text-decoration: none; font-weight: 600; padding: 6px 12px; background: #e5f1ff; border-radius: 16px; }

        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); backdrop-filter: blur(5px); justify-content:center; align-items:center; z-index:999; flex-direction: column;}
        #qrcode-gen { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        #reader { width: 100%; max-width: 400px; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .close-btn { margin-top: 20px; background: white; color: black; padding: 10px 30px; border-radius: 20px; }
    </style>
</head>
<body>
    <div class="card">
        <h3 style="margin-top:0;">V19 ä¸¥æ ¼æ’åºç‰ˆ <span class="tag">Strict-Order</span></h3>
        <div style="font-size:0.85em; color:#86868b; margin-bottom:15px">ä¿®å¤åˆå¹¶é”™ä¹± â€¢ è§†é¢‘å®Œç¾æ’­æ”¾ â€¢ 100%å®Œæ•´æ€§</div>
        
        <div class="input-group">
            <input type="text" id="credentialInput" placeholder="32ä½å‡­è¯" maxlength="32">
            <button class="btn-icon" onclick="genKey()" title="éšæœº">ğŸ²</button>
            <button class="btn-icon" onclick="showQR()" title="ç ">ğŸ“±</button>
            <button class="btn-icon" onclick="scanQR()" title="æ‰«">ğŸ“·</button>
            <button class="btn-main" onclick="initApp()">è¿æ¥</button>
        </div>
        
        <div id="status">ç­‰å¾…è¿æ¥...</div>

        <div id="panel" style="display:none;">
            <div class="file-box" onclick="document.getElementById('fileInput').click()">
                <div style="font-size:2em; margin-bottom:10px">ğŸ“‚</div>
                <div style="font-weight:600">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <div style="font-size:0.8em; color:#86868b; margin-top:5px">æ”¯æŒè§†é¢‘/æ–‡æ¡£ (Max 1GB)</div>
                <input type="file" id="fileInput" style="display:none">
            </div>
            
            <div class="progress-wrap" id="prog-box">
                <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
                <div class="progress-info">
                    <span id="p-txt">0%</span>
                    <span id="p-detail">0/0 MB</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h4 style="margin:0 0 15px 0; color:#86868b">ä¼ è¾“è®°å½•</h4>
        <div id="history"><div style="text-align:center; color:#d2d2d7; font-size:0.9em;">æš‚æ— è®°å½•</div></div>
    </div>

    <div id="qr-modal" class="modal" onclick="this.style.display='none'"><div id="qrcode-gen"></div></div>
    <div id="scan-modal" class="modal"><div id="reader"></div><button class="close-btn" onclick="stopScan()">å…³é—­æ‘„åƒå¤´</button></div>

    <script>
        const CHUNK_SIZE = 64 * 1024; 
        const CONFIG = {
            pbkdf2: { name: "PBKDF2", hash: "SHA-256", iterations: 500000 },
            aes: { name: "AES-GCM", length: 256 },
            salt_room: "V19_ORDER_ROOM", salt_key: "V19_ORDER_KEY"
        };

        // --- åŠ å¯†æ ¸å¿ƒ ---
        const SecurityCore = {
            encKey: null,
            async init(password) {
                const enc = new TextEncoder();
                const baseKey = await crypto.subtle.importKey("raw", enc.encode(password), {name:"PBKDF2"}, false, ["deriveKey"]);
                this.encKey = await crypto.subtle.deriveKey({ ...CONFIG.pbkdf2, salt: enc.encode(CONFIG.salt_key) }, baseKey, CONFIG.aes, false, ["encrypt", "decrypt"]);
                const hash = await crypto.subtle.digest('SHA-256', enc.encode(password + CONFIG.salt_room));
                return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('').substr(0,32);
            },
            async encrypt(chunk) {
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const cipher = await crypto.subtle.encrypt({name:"AES-GCM", iv}, this.encKey, chunk);
                // æ‰“åŒ… IV + Cipher
                const packed = new Uint8Array(12 + cipher.byteLength);
                packed.set(iv, 0); packed.set(new Uint8Array(cipher), 12);
                return packed; // è¿”å› ArrayBuffer
            },
            async decrypt(packed) {
                const iv = packed.slice(0, 12);
                const cipher = packed.slice(12);
                return await crypto.subtle.decrypt({name:"AES-GCM", iv}, this.encKey, cipher);
            }
        };

        // --- å…¨å±€çŠ¶æ€ ---
        let peer, conn;
        let incoming = { 
            chunks: [], // ä½¿ç”¨ç¨€ç–æ•°ç»„å­˜å‚¨ï¼ŒæŒ‰ index æ’å…¥
            meta: null, 
            receivedCount: 0, 
            totalChunks: 0 
        };
        let isBusy = false;

        async function initApp() {
            const code = document.getElementById('credentialInput').value.trim();
            if(code.length !== 32) return alert("å‡­è¯éœ€32ä½");
            setStatus("ğŸ” æ­£åœ¨åŠ å¯†è¿æ¥...");
            setTimeout(async () => {
                try {
                    const roomId = await SecurityCore.init(code);
                    connectPeer(roomId);
                } catch(e) { setStatus("âŒ åˆå§‹åŒ–å¤±è´¥"); }
            }, 50);
        }

        function connectPeer(roomId) {
            if(peer) peer.destroy();
            peer = new Peer(roomId, {
                host: '0.peerjs.com', port: 443, secure: true, path: '/',
                config: { iceServers: [
                    { urls: 'stun:stun.miwifi.com' },
                    { urls: 'stun:stun.chat.bilibili.com' },
                    { urls: 'stun:stun.qq.com' }
                ]}
            });
            peer.on('open', () => { setStatus("âœ… èŠ‚ç‚¹å°±ç»ª (CN-STUN)"); peer.on('connection', setupConn); });
            peer.on('error', e => {
                if(e.type === 'unavailable-id') {
                    setStatus("ğŸ”— è¿æ¥æˆ¿ä¸»...");
                    const guest = new Peer({ host: '0.peerjs.com', port: 443, secure: true, path: '/', config: { iceServers: [{ urls: 'stun:stun.miwifi.com' }] } });
                    guest.on('open', () => setupConn(guest.connect(roomId)));
                } else setStatus("âŒ " + e.type);
            });
        }

        function setupConn(c) {
            conn = c;
            conn.on('open', () => { setStatus("ğŸ¤ è¿æ¥æˆåŠŸ"); document.getElementById('panel').style.display = 'block'; });
            conn.on('data', handleData);
            conn.on('close', () => setStatus("ğŸ”Œ æ–­å¼€"));
        }

        // --- å‘é€é€»è¾‘ï¼šå¢åŠ  seq åºå· ---
        document.getElementById('fileInput').addEventListener('change', async e => {
            const file = e.target.files[0];
            if(!file || !conn) return;
            if(isBusy) return alert("å¿™ç¢Œä¸­");
            isBusy = true;
            document.getElementById('prog-box').style.display = 'block';
            
            // è®¡ç®—æ€»ç‰‡æ•°
            const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
            
            // å‘é€å…ƒæ•°æ®
            conn.send({ 
                type: 'meta', 
                name: file.name, 
                size: file.size, 
                mime: file.type || 'application/octet-stream',
                total: totalChunks // å‘ŠçŸ¥å¯¹æ–¹æ€»ç‰‡æ•°
            });
            
            let offset = 0;
            let seq = 0; // å½“å‰é¡µç 
            const reader = new FileReader();

            const readNext = () => {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };

            reader.onload = async (evt) => {
                if(!conn || !conn.open) return;
                const encrypted = await SecurityCore.encrypt(evt.target.result);
                
                // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šå‘é€æ—¶å¸¦ä¸Š seq åºå·
                conn.send({
                    type: 'chunk',
                    seq: seq,
                    payload: encrypted
                });

                offset += CHUNK_SIZE;
                seq++;
                
                const percent = Math.min(100, Math.round((offset / file.size) * 100));
                updateBar(percent, offset, file.size, "å‘é€ä¸­");

                if (offset < file.size) {
                    setTimeout(readNext, 0); 
                } else {
                    conn.send({ type: 'end' }); // ç»“æŸä¿¡å·
                    isBusy = false;
                    addHistory(file.name, "â¬† å‘é€", formatSize(file.size), null, file.type);
                    setStatus("âœ… å‘é€å®Œæ¯•");
                }
            };
            readNext();
        });

        // --- æ¥æ”¶é€»è¾‘ï¼šä¸¥æ ¼æŒ‰ seq å½’ä½ ---
        async function handleData(data) {
            // 1. å…ƒæ•°æ®
            if (data.type === 'meta') {
                incoming = { 
                    chunks: new Array(data.total), // é¢„åˆ†é…æ•°ç»„
                    meta: data, 
                    receivedCount: 0,
                    receivedBytes: 0,
                    totalChunks: data.total
                };
                isBusy = true;
                document.getElementById('prog-box').style.display = 'block';
                setStatus(`â¬‡ æ¥æ”¶: ${data.name}`);
                return;
            }

            // 2. æ•°æ®åˆ†ç‰‡ (å¸¦åºå·)
            if (data.type === 'chunk' && isBusy) {
                try {
                    const decrypted = await SecurityCore.decrypt(data.payload);
                    
                    // ğŸ”¥ æ ¸å¿ƒä¿®æ”¹ï¼šæŒ‰åºå·å­˜å…¥å¯¹åº”ä½ç½®ï¼Œé˜²æ­¢ä¹±åº
                    incoming.chunks[data.seq] = decrypted;
                    incoming.receivedCount++;
                    incoming.receivedBytes += decrypted.byteLength;

                    const percent = Math.min(100, Math.round((incoming.receivedCount / incoming.totalChunks) * 100));
                    updateBar(percent, incoming.receivedBytes, incoming.meta.size, "æ¥æ”¶ä¸­");

                } catch(e) {
                    console.error("Chunk error:", e);
                    // å³ä½¿è§£å¯†å¤±è´¥ä¹Ÿä¸è¦ä¸­æ–­æ•´ä¸ªæµç¨‹ï¼Œä½†è¿™å—æ•°æ®ä¼šä¸¢å¤±
                }
                return;
            }

            // 3. ç»“æŸä¿¡å·
            if (data.type === 'end') {
                finishReceive();
            }
        }

        function finishReceive() {
            // å®Œæ•´æ€§æ£€æŸ¥ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ç©ºæ´
            let missing = 0;
            for(let i=0; i<incoming.totalChunks; i++) {
                if(!incoming.chunks[i]) missing++;
            }

            if(missing > 0) {
                alert(`è­¦å‘Šï¼šæ–‡ä»¶æŸåï¼ä¸¢å¤±äº† ${missing} ä¸ªåˆ†ç‰‡ã€‚ç½‘ç»œç¯å¢ƒå¯èƒ½æå…¶æ¶åŠ£ã€‚`);
                setStatus("âŒ æ¥æ”¶å¤±è´¥ (ä¸¢åŒ…)");
                isBusy = false;
                return;
            }

            // åˆå¹¶ Blob
            let mime = incoming.meta.mime;
            if(!mime || mime==='application/octet-stream') {
                if(incoming.meta.name.match(/\.mp4$/i)) mime = 'video/mp4';
                else if(incoming.meta.name.match(/\.(jpg|png|jpeg)$/i)) mime = 'image/jpeg';
            }

            const blob = new Blob(incoming.chunks, { type: mime });
            const url = URL.createObjectURL(blob);
            
            addHistory(incoming.meta.name, "â¬‡ æ”¶åˆ°", formatSize(incoming.meta.size), url, mime);
            
            isBusy = false;
            // é‡Šæ”¾å†…å­˜
            incoming.chunks = []; 
            setStatus("âœ… æ¥æ”¶å®Œæˆ (å®Œæ•´æ€§æ ¡éªŒé€šè¿‡)");
        }

        // --- UI å·¥å…· ---
        function updateBar(p, curr, total, txt) {
            document.getElementById('p-fill').style.width = p + '%';
            document.getElementById('p-txt').innerText = `${txt} ${p}%`;
            document.getElementById('p-detail').innerText = `${formatSize(curr)}/${formatSize(total)}`;
        }

        function addHistory(name, type, size, url, mime) {
            const div = document.getElementById('history');
            if(div.innerText.includes('æš‚æ— ')) div.innerHTML = '';
            
            let preview = '';
            if (url) {
                if (mime && mime.startsWith('video/')) preview = `<video src="${url}" controls class="media-preview" playsinline></video>`;
                else if (mime && mime.startsWith('image/')) preview = `<img src="${url}" class="media-preview">`;
            }

            const isSend = type.includes('å‘é€');
            const html = `
                <div class="log-item">
                    <div class="log-top">
                        <div style="font-weight:600; color:${isSend?'#0066cc':'#34c759'}">${type}</div>
                        <div style="font-size:0.9em; color:#86868b">${size}</div>
                    </div>
                    <div style="word-break:break-all; font-family:monospace;">${name}</div>
                    ${url ? `<div style="margin-top:5px; display:flex; gap:10px; align-items:center;">
                        <a href="${url}" download="${name}" class="btn-dl">ä¿å­˜åˆ°æœ¬åœ°</a>
                    </div>` : ''}
                    ${preview}
                </div>`;
            div.innerHTML = html + div.innerHTML;
        }

        function genKey() {
            const arr = new Uint8Array(16); crypto.getRandomValues(arr);
            document.getElementById('credentialInput').value = Array.from(arr).map(b=>b.toString(16).padStart(2,'0')).join('');
        }
        function formatSize(b) { return b<1024?b+'B':b<1048576?(b/1024).toFixed(1)+'KB':(b/1048576).toFixed(1)+'MB'; }
        function setStatus(s) { document.getElementById('status').innerText = s; }

        // QR ç›¸å…³
        let html5QrCode;
        window.onload = () => {
            if(location.hash.includes('c=')) {
                document.getElementById('credentialInput').value = location.hash.split('c=')[1];
                setTimeout(initApp, 500); history.replaceState(null, null, ' ');
            }
        };
        function showQR() {
            const c = document.getElementById('credentialInput').value;
            if(c.length!=32) return alert("éœ€32ä½å‡­è¯");
            document.getElementById('qr-modal').style.display = 'flex';
            document.getElementById('qrcode-gen').innerHTML = '';
            new QRCode(document.getElementById('qrcode-gen'), { text: location.href.split('#')[0]+'#c='+c, width: 200, height: 200 });
        }
        function scanQR() {
            document.getElementById('scan-modal').style.display = 'flex';
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, 
                (decodedText) => { stopScan(); const code = decodedText.includes('c=') ? decodedText.split('c=')[1] : decodedText; if(code.length===32) { document.getElementById('credentialInput').value = code; setTimeout(initApp, 500); } }
            ).catch(() => { alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´(éœ€HTTPS)"); stopScan(); });
        }
        function stopScan() { if(html5QrCode) html5QrCode.stop().then(() => { html5QrCode.clear(); document.getElementById('scan-modal').style.display = 'none'; }).catch(()=>{}); else document.getElementById('scan-modal').style.display = 'none'; }
    </script>
</body>
</html>
